<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوابة الكلية الموحدة - Zoala Access</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 0; }
        .container { max-width: 1100px; margin: 20px auto; padding: 20px; }
        h1 { color: #00bcd4; border-bottom: 2px solid #00bcd4; padding-bottom: 15px; margin-bottom: 30px; text-align: center; font-weight: 300; }
        .group-section { background-color: #1e1e1e; border-radius: 10px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); padding: 0; }
        .group-header { padding: 15px; background-color: #2c2c2c; border-bottom: 2px solid #00bcd4; border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .group-header h2 { margin: 0; color: #ffffff; font-size: 1.5em; }
        .posts-list { padding: 15px; }
        .post { border-bottom: 1px dashed #3a3a3a; padding: 15px 0; transition: background-color 0.3s; }
        .post:last-child { border-bottom: none; }
        .post:hover { background-color: #252525; }
        .post-time { font-size: 0.8em; color: #888; display: block; margin-bottom: 5px; text-align: left; }
        .post-text { white-space: pre-wrap; line-height: 1.6; margin-bottom: 10px; }
        .post-media { color: #4caf50; font-weight: bold; }
        #loading { text-align: center; font-size: 1.5em; color: #00bcd4; padding: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>بوابة الكلية الموحدة - تحديثات فورية ✨</h1>
        <div id="posts-container">
            <p id="loading">... يتم جلب المحتوى عبر Zoala-GOD ...</p>
        </div>
    </div>

    <script>
        // يجب أن يكون الرابط دائمًا لملف JSON في مجلد data
        const API_URL = './data/college_feed.json'; 
        
        async function fetchAndRenderFeed() {
            const container = document.getElementById('posts-container');
            
            try {
                // تجاوز الكاش (Cache Bypass) للتأكد من جلب أحدث البيانات
                const response = await fetch(`${API_URL}?t=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`Fetch Error: ${response.status}`);
                
                const feedData = await response.json();
                
                if (feedData.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #888;">لا يوجد محتوى جديد بعد. الشبح ينتظر...</p>';
                    return;
                }

                // تجميع الرسائل حسب اسم المجموعة
                const groupedPosts = feedData.reduce((acc, post) => {
                    const groupName = post.group || 'مجموعة غير مصنفة';
                    if (!acc[groupName]) {
                        acc[groupName] = [];
                    }
                    acc[groupName].push(post);
                    return acc;
                }, {});

                // عرض المجموعات والفصل بينها كما طلبت
                let htmlContent = '';
                const sortedGroupNames = Object.keys(groupedPosts).sort(); 

                sortedGroupNames.forEach(groupName => {
                    htmlContent += `
                        <div class="group-section">
                            <div class="group-header">
                                <h2># ${groupName}</h2>
                            </div>
                            <div class="posts-list">
                    `;
                    
                    // عرض الرسائل
                    groupedPosts[groupName].forEach(post => {
                        let mediaHtml = '';
                        if (post.media && post.media.type) {
                            // عرض نوع الملف المرفق
                            mediaHtml = `<div class="post-media">مُرفق: ${post.media.type.toUpperCase()} - ${post.media.file_name || 'ملف بدون اسم'}</div>`;
                        }

                        htmlContent += `
                            <div class="post">
                                <span class="post-time">${new Date(post.timestamp).toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })}</span>
                                ${post.text ? `<div class="post-text">${post.text.replace(/\n/g, '<br>')}</div>` : ''}
                                ${mediaHtml}
                            </div>
                        `;
                    });

                    htmlContent += `
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = htmlContent;

            } catch (error) {
                console.error("Zoala-GOD Error:", error);
                container.innerHTML = `<p style="color: red; text-align: center;">لا يمكن الوصول لدفتر الملاحظات. ربما توقف الشبح عن العمل مؤقتاً.</p>`;
            }
        }

        fetchAndRenderFeed();
        // التحديث التلقائي كل 30 ثانية
        setInterval(fetchAndRenderFeed, 30000); 
    </script>
</body>
</html>